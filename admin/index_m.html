<html>

<head>
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <script type="text/javascript" src="words.js"></script>
    <style>
        .number {
            width: 70px
        }

        .table-values th {
            background: #686868;
            color: #FFF;
            font-weight: bold;
        }

        .table-values tr:nth-child(even) {
            background: #d0d0d0;
        }

        .error {
            border: 1px solid red;
        }

        .cbox {
            width: 350px;
            height: 150px;
            background: grey;
            border-width: 2px;
            border-style: solid;
            border-color: green;
            z-index: 0;
            margin: 8px;
        }

        .cbox2 {
            width: 70px;
            height: 70px;
            border-width: 2px;
            border-style: solid;
            background: none;
            border-color: green;
            z-index: 1;
            margin-top: -2px;
            margin-left: -2px;
        }
        .robot {
           position:relative;
            left: 180px;
            top: -164px;
            z-index: 10;
            transform: rotate(90deg);
        }
        .path{
            position: relative;
            left: 100px;
            top: -32px;
            width: 90px;
            height: 108px;
            background: none;
            z-index: 5;
          border-width: 4px 0px 0px 4px;
          border-style: solid ;

        }
    </style>
    <script type="text/javascript">
        var values = [];

        // the function loadSettings has to exist ...
        function load(settings, onChange) {
            if (!settings) return;

            $('.value').each(function () {
                var key = $(this).attr('id');
                var $key = $('#' + key + '.value');
                if ($key.attr('type') === 'checkbox') {
                    $key.prop('checked', settings[key]).change(function () {
                        onChange();
                    });
                } else {
                    $key.val(settings[key]).change(function () {
                        onChange();
                    }).keyup(function () {
                        onChange();
                    });
                }
            });
            $(".cbox").css("background", ($(".colorFloor").val()));
            $(".cbox").css("border-color", ($(".colorWall").val()));
            $(".cbox2").css("border-color", ($(".colorWall").val()));
            $(".path").css("border-color", ($(".colorPath").val()));
            $(".robot").attr('src',''+ $(".robotSel").val() + '.png');;
            console.log("run all....")

            $(".colorFloor").change(function () {
                console.log("changed...." + $(this).val())
                $(".cbox").css("background", ($(this).val()));
            });
            $(".colorWall").change(function () {
                console.log("changed...." + $(this).val())
                $(".cbox").css("border-color", ($(this).val()));
                $(".cbox2").css("border-color", ($(this).val()));
            });
            $(".colorPath").change(function () {
                console.log("changed...." + $(this).val())
                $(".path").css("border-color", ($(this).val()));
            });
            $(".robotSel").change(function () {
                console.log("changed....Pic" + $(this).val())
                $(".robot").attr('src',''+ $(this).val() + '.png');;
            });



            onChange(false);

            var namespace = adapter + '.' + instance + '.';

            socket.emit('getObjectView', 'system', 'state', {
                startkey: namespace,
                endkey: namespace + '\u9999'
            }, function (err, res) {
                if (!err && res) {
                    var _res = {};
                    for (var i = 0; i < res.rows.length; i++) {
                        var obj = res.rows[i].value;
                        values.push({
                            name: obj._id.substring(namespace.length),
                            link: obj.native.link,
                            read: obj.common.read,
                            write: obj.common.write,
                            regex: obj.native.regex,
                            role: obj.common.role,
                            type: obj.common.type,
                            unit: obj.common.unit,
                            interval: obj.native.interval,
                            substitute: obj.native.substitute,
                            offset: obj.native.offset,
                            factor: obj.native.factor,
                            obj: obj
                        });
                    }
                }

                var newValues = JSON.parse(JSON.stringify(values));
                var __values2table;
                if (typeof values2table !== 'undefined') __values2table = values2table;
                __values2table = __values2table || _values2table;
                __values2table('values', newValues, onChange, function () {
                    if (!newValues.length) {
                        $('.table-button-add').trigger('click');
                    }

                    $('.values-input[data-name="name"]').change(function () {
                        var val = $(this).val();
                        var error = '';
                        if (!val) {
                            error = 'Empty names are not allowed';
                        } else if (val.indexOf(' ') !== -1) {
                            error = 'Spaces are not allowed';
                        }
                        if (error) {
                            $(this).addClass(error).attr('title', _(error));
                        } else {
                            $(this).removeClass('error').attr('title', '');
                        }
                    });
                    $('.values-input[data-name="type"]').change(function () {
                        var id = $(this).data('index');
                        var val = $(this).val();
                        if (val === 'number') {
                            $('.values-input[data-name="factor"][data-index="' + id + '"]')
                                .show();
                            $('.values-input[data-name="offset"][data-index="' + id + '"]')
                                .show();
                        } else {
                            $('.values-input[data-name="factor"][data-index="' + id + '"]')
                                .hide();
                            $('.values-input[data-name="offset"][data-index="' + id + '"]')
                                .hide();
                        }
                        if (val === 'boolean' || val === 'json') {
                            $('.values-input[data-name="unit"][data-index="' + id + '"]')
                                .hide();
                        } else {
                            $('.values-input[data-name="unit"][data-index="' + id + '"]')
                                .show();
                        }
                    }).each(function () {
                        var id = $(this).data('index');
                        var val = $(this).val();
                        if (val === 'number') {
                            $('.values-input[data-name="factor"][data-index="' + id + '"]')
                                .show();
                            $('.values-input[data-name="offset"][data-index="' + id + '"]')
                                .show();
                        } else {
                            $('.values-input[data-name="factor"][data-index="' + id + '"]')
                                .hide();
                            $('.values-input[data-name="offset"][data-index="' + id + '"]')
                                .hide();
                        }
                        if (val === 'boolean' || val === 'json') {
                            $('.values-input[data-name="unit"][data-index="' + id + '"]')
                                .hide();
                        } else {
                            $('.values-input[data-name="unit"][data-index="' + id + '"]')
                                .show();
                        }

                    });
                });
            });
        }

        function processTasks(tasks, cb) {
            if (!tasks || !tasks.length) {
                cb && cb();
                return;
            }

            var task = tasks.pop();

            if (typeof task === 'object') {
                socket.emit('setObject', task._id, task, function (err) {
                    if (err) console.error(err);
                    setTimeout(function () {
                        processTasks(tasks, cb);
                    }, 0);
                });
            } else {
                socket.emit('delState', task, function (err) {
                    if (err) console.error(err);
                    socket.emit('delObject', task, function (err) {
                        if (err) console.error(err);
                        setTimeout(function () {
                            processTasks(tasks, cb);
                        }, 0);
                    });
                });
            }
        }

        function save(callback) {
            var obj = {};
            $('.value').each(function () {
                var $this = $(this);
                if ($this.attr('type') === 'checkbox') {
                    obj[$this.attr('id')] = $this.prop('checked');
                } else {
                    obj[$this.attr('id')] = $this.val();
                }
            });
            var tokenLength = obj.token.replace(/\s/g, '').length;
            if (tokenLength !== 32 && tokenLength !== 96) {
                showMessage(_('Invalid token length. Expected 32 or 96 HEX chars.'));
                return;
            }

            callback(obj);
        }
    </script>
</head>

<body>
    <div class="m adapter-container"
        style="background-image: url('S5.png'); background-repeat: no-repeat; background-position: 20px 110px;  background-size: 520px ;">

        <div class="row">
            <!-- Tabs navigation -->
            <div class="col s12">
                <ul class="tabs">
                    <li class="tab col s2">
                        <a href="#tab-main" class="translate" data-lang="Main">Options</a>
                    </li>
                    <li class="tab col s2">
                        <a href="#tab-valetudo" class="translate" data-lang="Valetudo">Devices</a>
                    </li>
                </ul>
            </div>

            <div id="tab-main" class="col s12 page">

                <div class="row">
                    <div class="row">
                        <div class="col s12 m2 l1">
                            <img src="mihome-vacuum.png" class="logo">
                        </div>
                        <div class="col s12 m8 l10">
                            <h6 class="translate">adapter for control of Xiaomi vacuum cleaner V1 and S5</h6>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="row" style="background-color: #64b5f6;">
                        <div class="col s12">
                            <span class="translate">connection settings</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <input class="value" id="token" size="60" maxlength="96" />
                            <label for="token" class="translate">Token</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m4 l2">
                            <input class="value" id="ip" size="15" />
                            <label class="translate" for="ip">IP address:</label>
                        </div>

                        <div class="col s12 m3 l1 offset-m1 offset-l1">
                            <input class="value number" id="port" size="5" maxlength="5" type="number" />
                            <label class="translate" for="port">Vacuum port:</label>
                        </div>

                        <div class="col s12 m3 l1 offset-m1 offset-l1">
                            <input class="value number" id="ownPort" size="5" maxlength="5" type="number" />
                            <label class="translate" for="ownPort">Own port:</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12 m4 l2">
                            <input class="value" id="param_pingInterval" size="15" />
                            <label class="translate" for="param_pingInterval">Request Intervall</label>
                        </div>
                    </div>
                    <div class="divider"></div>
                    <div class="row" style="background-color: #64b5f6;">
                        <div class="col s12">
                            <span class="translate">additional settings</span>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col s12 m6">
                            <input class="value" id="enableAlexa" type="checkbox" />
                            <span class="translate">add a state for Alexa</span>
                        </div>
                        <div class="col s12 m6">
                            <input class="value" id="enableSelfCommands" type="checkbox" />
                            <span class="translate">Send own commands</span>
                        </div>
                        <div class="col s4">
                            <input class="value" id="enableResumeZone" type="checkbox"
                                data-link="resume-paused-zonecleaning-with-start-button" />
                            <span class="translate">Resume paused zonecleaning with start button</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Valetudo -->
            <div id="tab-valetudo" class="col s12 page">
                <div class="row">
                    <div class="col s6 m4 l2">
                        <img src="valetudo_logo_small.svg" class="logo">
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m6">
                        <input class="value" id="enableValetudo" type="checkbox" />
                        <span class="translate">Enable Valetudo</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m4 l2">
                        <input class="value colorFloor" id="valetudo_color_floor" size="15"/>
                        <label class="translate" for="valetudo_color_floor">Color floor:</label>
                    </div>
                    <div class="col s12 m4 l2">
                        <input class="value colorWall" id="valetudo_color_wall" size="15"/>
                        <label class="translate" for="valetudo_color_wall">Color wall:</label>
                    </div>
                    <div class="col s12 m4 l2">
                        <input class="value colorPath" id="valetudo_color_path" size="15"/>
                        <label class="translate" for="valetudo_color_path">Color path:</label>
                    </div>
                </div>
                <div class="row">
                    <div class="input-field col s12 m5 l3">
                        <select class="value robotSel" id="robot_select">
                            <option value="" disabled selected class="translate">Choose your robot</option>
                            <option value="robot" data-icon="./robot.png">Robot 1</option>
                            <option value="robot1" data-icon="./robot1.png">Robot 2</option>
                        </select>
                        <label class="translate">Robot images</label>
                    </div>
                </div>
                <div class="row">
                    <label class="translate">Map preview</label>
                    <div class="cbox">
                        <div class="cbox2">                            
                        </div>
                        <div class="path">                            
                        </div>
                        <img class="robot" src="./robot1.png" height="42" width="42">
                    </div>
                </div>


            </div>

        </div>


</body>

</html>